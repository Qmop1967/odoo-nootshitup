# Enhanced Zoho-Odoo Sync Service with Images

## ğŸ¯ Overview

This enhanced synchronization service provides **one-way synchronization** from Zoho Books to Odoo with the following advanced features:

### âœ¨ Key Features

1. **ğŸ”„ Product Synchronization**
   - Continuous monitoring and mirroring of all product data
   - One-way sync from Zoho Books â†’ Odoo
   - Automatic conflict resolution (Zoho data always wins)

2. **ğŸ†” Unique Product IDs**
   - Each product gets a unique `x_zoho_item_id` field in Odoo
   - Maintains perfect relationship tracking between systems
   - Prevents duplicate products during sync

3. **ğŸ–¼ï¸ Image Synchronization**
   - Downloads product images from Zoho Books
   - Uploads and attaches images to corresponding Odoo products
   - Tracks image changes and updates automatically
   - Stores images locally with backup

4. **ğŸ’± Currency Conversion**
   - Automatic USD to IQD conversion (1500 exchange rate)
   - Smart price detection and conversion

5. **ğŸ“Š Comprehensive Logging**
   - Service logs (`sync_service_images.log`)
   - Conflict resolution logs (`conflicts.log`)
   - Change tracking logs (`changes.log`)
   - Image sync logs (`images.log`)

6. **ğŸ”§ Background Service**
   - Runs as systemd service
   - Automatic restart on failure
   - Scheduled execution every 5 minutes

## ğŸ“ File Structure

```
/opt/odoo/migration/
â”œâ”€â”€ zoho_odoo_sync_service_with_images.py    # Enhanced service
â”œâ”€â”€ sync_service_manager_images.py           # Management interface
â”œâ”€â”€ add_zoho_field.py                        # Database schema setup
â”œâ”€â”€ logs/
â”‚   â”œâ”€â”€ sync_service_images.log              # Main service log
â”‚   â”œâ”€â”€ conflicts.log                        # Conflict resolution
â”‚   â”œâ”€â”€ changes.log                          # Data changes
â”‚   â””â”€â”€ images.log                           # Image sync events
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ sync_service/
â”‚   â”‚   â””â”€â”€ sync_tracking_images.json        # Sync tracking data
â”‚   â””â”€â”€ product_images/                      # Downloaded images
â””â”€â”€ config/
    â”œâ”€â”€ zoho_config.json                     # API configuration
    â””â”€â”€ field_mapping.json                   # Field mappings
```

## ğŸš€ Installation & Setup

### 1. Install the Enhanced Service

```bash
cd /opt/odoo/migration
python3 sync_service_manager_images.py install
```

### 2. Start the Service

```bash
python3 sync_service_manager_images.py start
```

### 3. Check Service Status

```bash
python3 sync_service_manager_images.py status
```

## ğŸ® Management Commands

### Basic Service Control

```bash
# Install and enable service
python3 sync_service_manager_images.py install

# Start service
python3 sync_service_manager_images.py start

# Stop service
python3 sync_service_manager_images.py stop

# Restart service
python3 sync_service_manager_images.py restart

# Check status
python3 sync_service_manager_images.py status
```

### Monitoring & Logs

```bash
# View service logs (last 50 lines)
python3 sync_service_manager_images.py logs

# View more lines
python3 sync_service_manager_images.py logs 100

# View sync statistics
python3 sync_service_manager_images.py stats

# View conflicts log
python3 sync_service_manager_images.py conflicts

# View changes log
python3 sync_service_manager_images.py changes

# View image sync log
python3 sync_service_manager_images.py images

# View downloaded images
python3 sync_service_manager_images.py image-dir
```

### One-time Operations

```bash
# Run one-time sync with images
python3 sync_service_manager_images.py sync-once

# Live monitoring
python3 sync_service_manager_images.py monitor
```

## ğŸ“Š Monitoring & Statistics

### Service Status Dashboard

The `status` command shows:

```
ğŸ“Š ENHANCED SERVICE STATUS
========================================
Active: âœ… YES
Enabled: âœ… YES

ğŸ“ˆ SYNC STATISTICS:
Enhanced Sync Statistics
========================================================
Total Syncs: 15
Last Sync: 2025-05-24T07:30:45.123456
Duration: 12.3 seconds
Products Added: 5
Products Updated: 8
Products Deleted: 0
ğŸ–¼ï¸ Images Synced: 12
âŒ Image Failures: 1
Errors: 0
Conflicts Resolved: 3

ğŸ“ˆ RECENT SYNC HISTORY (last 10):
  2025-05-24T07:30:45: +0 ~2 -0 ğŸ–¼ï¸1 âŒ0
  2025-05-24T07:25:45: +1 ~0 -0 ğŸ–¼ï¸1 âŒ0
  ...

ğŸ–¼ï¸ IMAGE STATISTICS:
Total Products with Images: 45
Recent Image Syncs:
  Product 123456: product_123456_a1b2c3d4.jpg (2025-05-24T07:30:45)
  Product 123457: product_123457_e5f6g7h8.png (2025-05-24T07:29:12)
  ...
```

### Image Directory

View downloaded product images:

```bash
python3 sync_service_manager_images.py image-dir
```

Output:
```
ğŸ–¼ï¸ DOWNLOADED PRODUCT IMAGES:
==================================================
Total Images: 152
Recent Images (last 10):
  ğŸ“¸ product_123456_a1b2c3d4.jpg (245.7 KB) - 2025-05-24 07:30:45
  ğŸ“¸ product_123457_e5f6g7h8.png (189.2 KB) - 2025-05-24 07:29:12
  ...
```

## ğŸ”„ How It Works

### 1. Product Synchronization Process

1. **Fetch Products**: Retrieves all products from Zoho Books using pagination
2. **Compare Data**: Calculates checksums to detect changes
3. **Conflict Detection**: Identifies differences between Zoho and Odoo
4. **Resolution**: Always prioritizes Zoho data over Odoo data
5. **Update/Create**: Applies changes to Odoo products
6. **Cleanup**: Removes products deleted from Zoho

### 2. Image Synchronization Process

1. **Image Detection**: Checks if product has image URL in Zoho
2. **Change Detection**: Compares image URLs to detect updates
3. **Download**: Downloads image from Zoho with authentication
4. **Processing**: Determines file type and generates unique filename
5. **Upload**: Converts to base64 and uploads to Odoo
6. **Attachment**: Creates attachment and sets as product image
7. **Tracking**: Records image sync status and metadata

### 3. Unique ID System

- **Field**: `x_zoho_item_id` (custom field in Odoo)
- **Purpose**: Maintains perfect 1:1 relationship between systems
- **Benefits**: 
  - Prevents duplicate products
  - Enables accurate updates
  - Tracks deletions properly

## ğŸ”§ Configuration

### Field Mapping

The service uses intelligent field mapping:

```json
{
  "products": {
    "zoho_books": {
      "name": "name",
      "rate": "list_price",
      "purchase_rate": "standard_price", 
      "description": "description",
      "sku": "default_code",
      "item_id": "x_zoho_item_id"
    },
    "default_values": {
      "type": "product",
      "sale_ok": true,
      "purchase_ok": true,
      "tracking": "none"
    }
  }
}
```

### Currency Conversion

- **Exchange Rate**: 1 USD = 1500 IQD
- **Logic**: If price < 100, applies conversion
- **Fields**: Both `list_price` and `standard_price`

## ğŸ“‹ Log Files

### 1. Service Log (`sync_service_images.log`)
```
2025-05-24 07:30:45 - ZohoOdooSyncImages - INFO - ğŸš€ Starting sync cycle with images...
2025-05-24 07:30:47 - ZohoOdooSyncImages - INFO - âœ… Total products from Zoho: 2154
2025-05-24 07:30:52 - ZohoOdooSyncImages - INFO - âœ… Sync cycle completed: +5 ~8 -0 ğŸ–¼ï¸12 âŒ0
```

### 2. Changes Log (`changes.log`)
```
2025-05-24 07:30:48 - CREATED: Product 'New Widget' (Zoho ID: 123456, Odoo ID: 789)
2025-05-24 07:30:49 - UPDATED: Product 'Updated Widget' (Odoo ID: 790)
2025-05-24 07:30:50 - DELETED: Product 'Removed Widget' (Odoo ID: 791)
```

### 3. Conflicts Log (`conflicts.log`)
```
2025-05-24 07:30:49 - CONFLICT RESOLVED: Product ID 790 - Fields: name, list_price - Overridden with Zoho data
```

### 4. Images Log (`images.log`)
```
2025-05-24 07:30:48 - Downloaded image for product 123456: product_123456_a1b2c3d4.jpg
2025-05-24 07:30:49 - Uploaded image to Odoo for product 789: product_123456_a1b2c3d4.jpg
```

## âš ï¸ Important Features

### 1. One-Way Sync Only
- **Direction**: Zoho Books â†’ Odoo
- **Conflict Resolution**: Zoho data always wins
- **Data Safety**: Odoo changes are overwritten

### 2. Automatic Backups
- Tracking data is backed up before each save
- Keeps last 5 backups automatically
- Image files are preserved locally

### 3. Error Handling
- Graceful failure handling
- Detailed error logging
- Service auto-restart on failure

### 4. Rate Limiting
- Respects API rate limits
- Built-in delays between requests
- Timeout protection

## ğŸ†˜ Troubleshooting

### Service Won't Start
```bash
# Check service status
systemctl status zoho-odoo-sync-images

# View detailed logs
journalctl -u zoho-odoo-sync-images -f

# Check permissions
ls -la /opt/odoo/migration/
```

### Images Not Syncing
```bash
# Check image log
python3 sync_service_manager_images.py images

# Check image directory
python3 sync_service_manager_images.py image-dir

# Check disk space
df -h /opt/odoo/migration/data/product_images/
```

### Sync Errors
```bash
# View recent logs
python3 sync_service_manager_images.py logs 100

# Check conflicts
python3 sync_service_manager_images.py conflicts

# Run manual sync
python3 sync_service_manager_images.py sync-once
```

## ğŸ‰ Success Indicators

### âœ… Perfect Sync Status

When everything is working correctly, you should see:

1. **Service Status**: Active and Enabled
2. **Sync Statistics**: Regular successful syncs
3. **Image Syncs**: Images being downloaded and uploaded
4. **No Conflicts**: Minimal conflict resolution needed
5. **Equal Counts**: Zoho and Odoo product counts match
6. **Recent Activity**: Regular entries in change logs

### ğŸ“Š Monitoring Dashboard

Use the live monitoring feature:
```bash
python3 sync_service_manager_images.py monitor
```

This shows real-time service status updates every 5 seconds.

---

## ğŸ“ Support

For issues or questions about the enhanced sync service:

1. Check the log files first
2. Run diagnostics with `sync-once`
3. Review the tracking data in `sync_tracking_images.json`
4. Monitor the service with live monitoring

The enhanced service provides complete product and image synchronization with comprehensive logging and monitoring capabilities! 